{% extends "base.html" %}
{% load static %}

{% block title %}Calendar · CareHub{% endblock %}

{% block content %}
<h3 class="mb-3">Appointments</h3>

<div class="d-flex align-items-center gap-2 mb-3">
  <label class="form-label me-2 mb-0" for="physicianSelect">Physician:</label>
  <select id="physicianSelect" class="form-select" style="max-width: 260px;">
    {% if default_physician_id %}
      <option value="{{ default_physician_id }}">Current</option>
    {% else %}
      <option value="">Select…</option>
    {% endif %}
  </select>

  <label class="form-label ms-3 me-2 mb-0" for="durationSelect">Duration (view/book):</label>
  <select id="durationSelect" class="form-select" style="max-width: 140px;">
    <option value="30" selected>30 min</option>
    <option value="45">45 min</option>
    <option value="60">60 min</option>
  </select>

  <button id="reloadBtn" class="btn btn-outline-secondary ms-2">Reload</button>
</div>

{% if is_physician %}
<div class="alert alert-info py-2">
  Tip: Drag or click on the calendar to create a free-time window at that start.
  You’ll choose <strong>30 / 45 / 60</strong> in a popup. Patients then book inside it.
</div>
{% endif %}

<!-- Config for JS -->
<div id="cal-config"
     data-physician-id="{{ default_physician_id|default:'' }}"
     data-is-physician="{% if is_physician %}1{% else %}0{% endif %}">
</div>

<div id="calendar"></div>

<!-- Toast -->
<div id="toast" class="toast align-items-center text-white bg-dark border-0 position-fixed"
     role="alert" aria-live="assertive" aria-atomic="true"
     style="top:16px; right:16px; z-index:9999;">
  <div class="d-flex">
    <div class="toast-body">...</div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
  </div>
</div>

<!-- Physician duration picker modal -->
<div class="modal fade" id="durationPickerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:360px;">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">Create availability</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted" id="pickedStartText">Start:</div>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-primary dur-btn" data-min="30">30 minutes</button>
          <button type="button" class="btn btn-outline-primary dur-btn" data-min="45">45 minutes</button>
          <button type="button" class="btn btn-outline-primary dur-btn" data-min="60">60 minutes</button>
        </div>
      </div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
  function showToast(msg, ok = true) {
    const el = document.getElementById('toast');
    el.classList.remove('bg-danger','bg-dark');
    el.classList.add(ok ? 'bg-dark' : 'bg-danger');
    el.querySelector('.toast-body').textContent = msg;
    const bsToast = new bootstrap.Toast(el, { delay: 2200 });
    bsToast.show();
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
    return null;
  }

  document.addEventListener('DOMContentLoaded', function () {
    const cfgEl = document.getElementById('cal-config');
    const DEFAULT_PHYSICIAN_ID = cfgEl.dataset.physicianId || "";
    const IS_PHYSICIAN = cfgEl.dataset.isPhysician === "1";

    const calEl = document.getElementById('calendar');
    const physicianSelect = document.getElementById('physicianSelect');
    const durationSelect = document.getElementById('durationSelect');
    const reloadBtn = document.getElementById('reloadBtn');

    // modal bits
    const modalEl = document.getElementById('durationPickerModal');
    const modal = new bootstrap.Modal(modalEl);
    const pickedStartText = document.getElementById('pickedStartText');
    let pendingStartIso = null;   // selection start we’ll use to create window

    // Ensure a physician is preselected when available
    if (DEFAULT_PHYSICIAN_ID && !physicianSelect.value) {
      physicianSelect.value = DEFAULT_PHYSICIAN_ID;
    }

    const calendar = new FullCalendar.Calendar(calEl, {
      initialView: 'timeGridWeek',
      height: 'auto',
      nowIndicator: true,

      // 15-min grid so 45-min selections/starts align
      slotDuration: '00:15:00',
      snapDuration: '00:15:00',
      slotLabelInterval: '01:00',
      slotMinTime: '06:00:00',
      slotMaxTime: '22:00:00',

      selectable: IS_PHYSICIAN,
      selectMirror: true,
      unselectAuto: true,

      headerToolbar: {
        start: 'prev,next today',
        center: 'title',
        end: 'dayGridMonth,timeGridWeek,timeGridDay'
      },

      // Render events (green availables + red booked) from backend
      events: async (info, success, failure) => {
        const physicianId = physicianSelect.value || DEFAULT_PHYSICIAN_ID;
        const duration = durationSelect.value || 30;
        if (!physicianId) { success([]); return; }

        const url =
          `/api/physicians/${physicianId}/slots/` +
          `?start=${encodeURIComponent(info.startStr)}` +
          `&end=${encodeURIComponent(info.endStr)}` +
          `&duration=${encodeURIComponent(duration)}`;

        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (!res.ok) {
            const t = await res.text().catch(()=> '');
            throw new Error(t || 'Failed to load slots');
          }
          const data = await res.json();
          success(data);
        } catch (e) {
          console.error(e);
          failure(e);
          showToast('Error loading slots', false);
        }
      },

      // PHYSICIAN: show modal to pick 30/45/60 — we create exactly one window of that length
      select: (selectionInfo) => {
        if (!IS_PHYSICIAN) return;
        const physicianId = physicianSelect.value || DEFAULT_PHYSICIAN_ID;
        if (!physicianId) { showToast('Select a physician first', false); return; }

        pendingStartIso = selectionInfo.start.toISOString();
        pickedStartText.textContent = `Start: ${selectionInfo.start.toLocaleString()}`;

        calendar.unselect(); // tidy highlight
        modal.show();
      },

      // PATIENT: click an "Available" block to book
      eventClick: async (info) => {
        if (IS_PHYSICIAN) return;  // physicians don’t book from their own calendar
        const physicianId = physicianSelect.value || DEFAULT_PHYSICIAN_ID;
        if (!physicianId) return;

        const duration = parseInt(durationSelect.value || '30', 10);
        const startIso = info.event.start.toISOString();

        if (!confirm(`Book ${duration} min starting ${info.event.start.toLocaleString()}?`)) return;

        try {
          const res = await fetch('/api/clinic/flex-appointments/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
              physician: physicianId,
              start: startIso,
              duration_minutes: duration,
              notes: ''
            })
          });
          if (!res.ok) {
            const t = await res.text().catch(()=> '');
            throw new Error(t || 'Booking failed');
          }
          await res.json();
          showToast('Appointment booked');
          calendar.removeAllEvents();
          calendar.refetchEvents();
        } catch (e) {
          console.error(e);
          showToast(e.message || 'Booking failed', false);
        }
      }
    });

    calendar.render();

    // Physician availability creation: choose length
    modalEl.querySelectorAll('.dur-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const min = parseInt(btn.dataset.min, 10);
        const physicianId = physicianSelect.value || DEFAULT_PHYSICIAN_ID;
        if (!physicianId || !pendingStartIso) return;

        const startDate = new Date(pendingStartIso);
        const endIso = new Date(startDate.getTime() + min * 60000).toISOString();

        try {
          const res = await fetch(`/api/physicians/${physicianId}/availability/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({ start: pendingStartIso, end: endIso })
          });
          if (!res.ok) {
            const t = await res.text().catch(()=> '');
            throw new Error(t || 'Failed to save availability');
          }

          // Switch view to the chosen length to make it obvious
          durationSelect.value = String(min);

          modal.hide();
          showToast(`Availability ${min} min created`);
          calendar.unselect();
          calendar.removeAllEvents();     // <<< clear old events
          calendar.refetchEvents();       // <<< fetch fresh with new duration
        } catch (e) {
          console.error(e);
          showToast(e.message || 'Failed to save availability', false);
        }
      });
    });

    // Controls: clear events before refetch to avoid mixing durations
    const refetchClean = () => { calendar.removeAllEvents(); calendar.refetchEvents(); };

    reloadBtn.addEventListener('click', refetchClean);
    physicianSelect.addEventListener('change', refetchClean);
    durationSelect.addEventListener('change', refetchClean);

    // Also allow single click to open the modal at that start (handy on mobile)
    if (IS_PHYSICIAN) {
      calendar.setOption('dateClick', (arg) => {
        const physicianId = physicianSelect.value || DEFAULT_PHYSICIAN_ID;
        if (!physicianId) { showToast('Select a physician first', false); return; }
        pendingStartIso = arg.date.toISOString();
        pickedStartText.textContent = `Start: ${arg.date.toLocaleString()}`;
        modal.show();
      });
    }
  });
</script>
{% endblock %}
