{% extends "base.html" %}
{% load tz %}

{% block content %}
<div class="container mt-4">

  <!-- Header + scope toggle for physicians -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">{{ title }}</h3>

    {% if user.is_authenticated and user.is_physician %}
      <div class="btn-group">
        <a href="{% url 'my_appointments' %}?scope=today"
           class="btn btn-sm btn-outline-secondary {% if 'Today' in title %}active{% endif %}">
          Today
        </a>
        <a href="{% url 'my_appointments' %}?scope=upcoming"
           class="btn btn-sm btn-outline-secondary {% if 'Upcoming' in title %}active{% endif %}">
          Upcoming
        </a>
      </div>
    {% endif %}
  </div>

  {% if appointments %}
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 12rem;">Date</th>
          <th style="width: 12rem;">Time</th>
          {% if user.is_patient %}
            <th>Physician</th>
          {% else %}
            <th>Patient</th>
          {% endif %}
          <th style="width: 10rem;">Status</th>
          <th style="width: 10rem;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for appt in appointments %}
        <tr>
          <td>{{ appt.slot.start|localtime|date:"M d, Y" }}</td>
          <td>{{ appt.slot.start|localtime|time:"H:i" }} – {{ appt.slot.end|localtime|time:"H:i" }}</td>

          {% if user.is_patient %}
            <td>{{ appt.physician.username }}</td>
          {% else %}
            <td>{{ appt.patient.username }}</td>
          {% endif %}

          <td>
            {% if appt.status == "CONFIRMED" %}
              <span class="badge bg-success">CONFIRMED</span>
            {% elif appt.status == "PENDING" %}
              <span class="badge bg-warning text-dark">PENDING</span>
            {% elif appt.status == "CANCELLED" %}
              <span class="badge bg-secondary">CANCELLED</span>
            {% else %}
              <span class="badge bg-light text-dark">{{ appt.status }}</span>
            {% endif %}
          </td>

          <td>
            {% comment %}
              Determine the peer for chat:
              - patient view → peer is physician
              - physician view → peer is patient
            {% endcomment %}
            {% if user.is_patient %}
              <a class="btn btn-sm btn-outline-primary"
                 href="{% url 'chat-room' appt.physician.id %}">Open Chat</a>
            {% else %}
              <a class="btn btn-sm btn-outline-primary"
                 href="{% url 'chat-room' appt.patient.id %}">Open Chat</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">No appointments found.</p>
  {% endif %}
</div>
{% endblock %}
