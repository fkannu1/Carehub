{% extends "base.html" %}
{% load tz %}

{% block title %}Appointments · CareHub{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Header + scope toggle for physicians -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">{{ title|default:"My Appointments" }}</h3>

    {% if user.is_authenticated and user.is_physician %}
      <div class="btn-group">
        <a href="{% url 'my_appointments' %}?scope=today"
           class="btn btn-sm btn-outline-secondary {% if title and 'Today' in title %}active{% endif %}">
          Today
        </a>
        <a href="{% url 'my_appointments' %}?scope=upcoming"
           class="btn btn-sm btn-outline-secondary {% if title and 'Upcoming' in title %}active{% endif %}">
          Upcoming
        </a>
      </div>
    {% endif %}
  </div>

  {# -------- NEW UNIFIED LIST (preferred) -------- #}
  {% if items %}
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 14rem;">Date</th>
          <th style="width: 16rem;">Time</th>
          <th>{{ peer_header|default:"Physician" }}</th>
          <th style="width: 10rem;">Status</th>
          <th style="width: 10rem;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in items %}
          <tr>
            <td>{{ r.date_str }}</td>
            <td>{{ r.time_str }}</td>
            <td>{{ r.peer_name }}</td>
            <td><span class="badge bg-success">{{ r.status }}</span></td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="{{ r.chat_url }}">Open Chat</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  {# -------- LEGACY FALLBACK (legacy Appointment queryset) -------- #}
  {% elif appointments %}
    <table class="table table-striped table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 14rem;">Date</th>
          <th style="width: 16rem;">Time</th>
          {% if user.is_patient %}
            <th>Physician</th>
          {% else %}
            <th>Patient</th>
          {% endif %}
          <th style="width: 10rem;">Status</th>
          <th style="width: 10rem;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for appt in appointments %}
          <tr>
            <td>{{ appt.slot.start|localtime|date:"M d, Y" }}</td>
            <td>{{ appt.slot.start|localtime|time:"H:i" }} – {{ appt.slot.end|localtime|time:"H:i" }}</td>

            {% if user.is_patient %}
              <td>{{ appt.physician.username }}</td>
            {% else %}
              <td>{{ appt.patient.username }}</td>
            {% endif %}

            <td>
              {% if appt.status == "CONFIRMED" %}
                <span class="badge bg-success">CONFIRMED</span>
              {% elif appt.status == "PENDING" %}
                <span class="badge bg-warning text-dark">PENDING</span>
              {% elif appt.status == "CANCELLED" %}
                <span class="badge bg-secondary">CANCELLED</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ appt.status }}</span>
              {% endif %}
            </td>

            <td>
              {% if user.is_patient %}
                <a class="btn btn-sm btn-outline-primary"
                   href="{% url 'chat-room' appt.physician.id %}">Open Chat</a>
              {% else %}
                <a class="btn btn-sm btn-outline-primary"
                   href="{% url 'chat-room' appt.patient.id %}">Open Chat</a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  {% else %}
    <p class="text-muted">No appointments found.</p>
  {% endif %}
</div>
{% endblock %}
